branches:
  only:
  - master
env:
  global:
  - BRAINIAK_REPO=danielsuo/brainiak
  - TWINE_USERNAME=brainiak-bot
  - 'secure: "JWCpO0caWN4M0xaGPqKMPPHg8WB6sybPQPcCFtXc+dwsD3mu+mDv7lGV3l/5sRoDqIi87uhXBtfnPVKao7AdPaLZoZc8ktBP3b7QwG49U479odN1OuxZcdLBmQBPZlAnqyH7wbM0xhkskr6Yl8gkKWynDfyod1GWbr/plcGRuX82unvuq5tkX8gNSdJ4vHbHGGcvgUbDkyEJdQz7y96qJn7VUpD4FhujO7bGyGVB2ZVcAcEyHuQZiyPxknrXSE0dnk0IeEH77DY40SLpPf5WG4fl/gGYLlccw2ZmBOAOYYE/nq9HF+/b5gnYp+0zLUCgA1tK9uC1UdT3IE24hr8XJMdMIog1BSVjv5k31RjFi0mwCVaasiCN/IOYvwrg+yod5UjXBag7f/Wjo3AEoUSByFERTr+Y7Gs+uCHQKT8Jw4mCTwmI+3JnH+4ZcuMbIQUr10uaocmpNuWhA1IVMTewIKjaAgY9qWy2X5e7X5/faYXlUhV68QiA5TB4MCvA+jeq84+bIk00HBnOadL/iAKFVhBlbkqe8OZWNbsBKFERWEVJFIoOLMg43NORWRs54Mi3eie4bNxWUwwPsxHR4FoBSeWjm2yorDbUIFDK57xZH3jUFu11xSXW3x9BqGWdgQg71j/P1nVKGMoHvPUBX0wO2CLQnSl6katSwgM6aLeJl1U="'
  - AWS_ACCESS_KEY_ID="AKIAJKBW6H2VKKQDHILQ"
  - 'secure: "gCGZuvBQVZ09rmH5tPUn3GT17NzyBX9JRO3SJwq6WcLbmKDRo50xAhqib/VAKfMXmcteaIPQdxjWUcohPXAoFQ67Z3Jx8abjxEIJ6t7IwIH3aRYWh7PX28Iu5Cr3b/pLbSBw0r+tj/X0mHsbS1dF/uVOBo4fSGN5f4li3EMv+iWQNimwC64uT+ywbzjdUPwJBZ+rVoyh/uxBR/14CpYMi2b1Bf79iVYZr1INShWH+4JNqw6RkJQVhQbAXq9CdSH3bNgyrnASno542cDa9l++xJhJ9okFTdWchiDj1FH4BhBLdEQHVEm790dAZGcE41APg8gW/4hDA8G5wXrCN/T+QtEEgzIDKJ9o/VImabjWcuB1oMERM4Rcvr0wpRNd+DCcPNyEpLPHlOV8WGiIu/5cgLv7O8n38+LmyjCNeJKKR9TxcCoZ53LhrwHgfcokElz1aXQvHcNh+IAG0WF0+OxclBiqEwvasyq8PT4r9MMNYwklINcSDO5RdK2xVJJbehFT81LodAJ9ydgrfagAB7haLq6JfdIucvlllmeVyLwznJm/Gtx9WNOFeSVEN0pufJWsiQJelu4S+4OesfdCCzypAXkSWQ2M4vQBcWNYjJ6Ns6svhNX/9wC9+QLPusAieLan2WDFjxrQwUM7n+J3/GxEEPI6heUGNh3n0wimmVpGxZo="'
  - AWS_DEFAULT_REGION="us-east-1"
jobs:
  include:
  - stage: test
    language: generic
  - os: linux
    dist: trusty
    sudo: required
    language: python
    python: '3.4'
    before_install:
    - python3 -m pip install -U pip awscli twine
    script:
    - ./bin/pr-check.sh
    addons:
      apt:
        packages:
        - build-essential libgomp1 libmpich-dev mpich
  - os: linux
    dist: trusty
    sudo: required
    language: python
    python: '3.5'
    before_install:
    - python3 -m pip install -U pip awscli twine
    script:
    - ./bin/pr-check.sh
    addons:
      apt:
        packages:
        - build-essential libgomp1 libmpich-dev mpich
  - os: linux
    dist: trusty
    sudo: required
    language: python
    python: '3.6'
    before_install:
    - python3 -m pip install -U pip awscli twine
    script:
    - ./bin/pr-check.sh
    addons:
      apt:
        packages:
        - build-essential libgomp1 libmpich-dev mpich
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - CC=/usr/local/opt/llvm/bin/clang
    - CXX=/usr/local/opt/llvm/bin/clang++
    - LDFLAGS="-L/usr/local/opt/llvm/lib -Wl,-rpath,/usr/local/opt/llvm/lib $LDFLAGS"
    - CPPFLAGS="-I/usr/local/opt/llvm/include $CPPFLAGS"
    - HOMEBREW_NO_AUTO_UPDATE=1
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    install:
    - brew install llvm mpich
    script:
    - ./bin/pr-check.sh
  - os: osx
    osx_image: xcode8
    language: generic
    env:
    - CC=/usr/local/opt/llvm/bin/clang
    - CXX=/usr/local/opt/llvm/bin/clang++
    - LDFLAGS="-L/usr/local/opt/llvm/lib -Wl,-rpath,/usr/local/opt/llvm/lib $LDFLAGS"
    - CPPFLAGS="-I/usr/local/opt/llvm/include $CPPFLAGS"
    - HOMEBREW_NO_AUTO_UPDATE=1
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    install:
    - brew install llvm mpich
    script:
    - ./bin/pr-check.sh
  - stage: build
    language: generic
    if: branch = master
  - os: linux
    dist: trusty
    sudo: required
    language: python
    python: '3.4'
    before_install:
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    install:
    - ./bin/build-dist.sh
    script:
    - ./bin/test-wheels.sh
    after_script:
    - aws s3 cp dist s3://brainiak/$TRAVIS_COMMIT/dist --recursive --acl=public-read
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - CC=/usr/local/opt/llvm/bin/clang
    - CXX=/usr/local/opt/llvm/bin/clang++
    - LDFLAGS="-L/usr/local/opt/llvm/lib -Wl,-rpath,/usr/local/opt/llvm/lib $LDFLAGS"
    - CPPFLAGS="-I/usr/local/opt/llvm/include $CPPFLAGS"
    - HOMEBREW_NO_AUTO_UPDATE=1
    - ARCHFLAGS="-arch x86_64"
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    install:
    - brew install llvm mpich
    - VERSIONS="3.4.4" ./bin/install-python-macos.sh
    - VERSIONS="3.4.4" ./bin/build-dist-macos.sh
    before_script:
    - brew uninstall -f --ignore-dependencies llvm mpich
    - unset CC
    - unset CXX
    - unset LDFLAGS
    - unset CPPFLAGS
    - unset ARCHFLAGS
    script:
    - VERSIONS="3.4.4" ./bin/test-wheels-macos.sh
    after_script:
    - aws s3 cp dist s3://brainiak/$TRAVIS_COMMIT/dist --recursive --acl=public-read
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - CC=/usr/local/opt/llvm/bin/clang
    - CXX=/usr/local/opt/llvm/bin/clang++
    - LDFLAGS="-L/usr/local/opt/llvm/lib -Wl,-rpath,/usr/local/opt/llvm/lib $LDFLAGS"
    - CPPFLAGS="-I/usr/local/opt/llvm/include $CPPFLAGS"
    - HOMEBREW_NO_AUTO_UPDATE=1
    - ARCHFLAGS="-arch x86_64"
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    install:
    - brew install llvm mpich
    - VERSIONS="3.5.3" ./bin/install-python-macos.sh
    - VERSIONS="3.5.3" ./bin/build-dist-macos.sh
    before_script:
    - brew uninstall -f --ignore-dependencies llvm mpich
    - unset CC
    - unset CXX
    - unset LDFLAGS
    - unset CPPFLAGS
    - unset ARCHFLAGS
    script:
    - VERSIONS="3.5.3" ./bin/test-wheels-macos.sh
    after_script:
    - aws s3 cp dist s3://brainiak/$TRAVIS_COMMIT/dist --recursive --acl=public-read
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - CC=/usr/local/opt/llvm/bin/clang
    - CXX=/usr/local/opt/llvm/bin/clang++
    - LDFLAGS="-L/usr/local/opt/llvm/lib -Wl,-rpath,/usr/local/opt/llvm/lib $LDFLAGS"
    - CPPFLAGS="-I/usr/local/opt/llvm/include $CPPFLAGS"
    - HOMEBREW_NO_AUTO_UPDATE=1
    - ARCHFLAGS="-arch x86_64"
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    install:
    - brew install llvm mpich
    - VERSIONS="3.6.0" ./bin/install-python-macos.sh
    - VERSIONS="3.6.0" ./bin/build-dist-macos.sh
    before_script:
    - brew uninstall -f --ignore-dependencies llvm mpich
    - unset CC
    - unset CXX
    - unset LDFLAGS
    - unset CPPFLAGS
    - unset ARCHFLAGS
    script:
    - VERSIONS="3.6.0" ./bin/test-wheels-macos.sh
    after_script:
    - aws s3 cp dist s3://brainiak/$TRAVIS_COMMIT/dist --recursive --acl=public-read
  - stage: s3
    language: generic
    if: branch = master
  - os: linux
    dist: trusty
    sudo: required
    language: python
    python: '3.4'
    before_install:
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    env: TWINE_REPOSITORY_URL=https://test.pypi.org/legacy
    install: aws s3 cp s3://brainiak/$TRAVIS_COMMIT/dist dist --recursive
    script:
    - ./bin/test-wheels.sh
    after_script:
    - if [ ! -z $TRAVIS_TAG ]; then twine upload dist/*; fi
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - HOMEBREW_NO_AUTO_UPDATE=1
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    - aws s3 cp s3://brainiak/$TRAVIS_COMMIT/dist dist --recursive
    if: branch = master
    install:
    - VERSIONS="3.4.4" ./bin/install-python-macos.sh
    script:
    - VERIONS="3.4.4" ./bin/test-wheels-macos.sh
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - HOMEBREW_NO_AUTO_UPDATE=1
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    - aws s3 cp s3://brainiak/$TRAVIS_COMMIT/dist dist --recursive
    if: branch = master
    install:
    - VERSIONS="3.5.3" ./bin/install-python-macos.sh
    script:
    - VERIONS="3.5.3" ./bin/test-wheels-macos.sh
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - HOMEBREW_NO_AUTO_UPDATE=1
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    - aws s3 cp s3://brainiak/$TRAVIS_COMMIT/dist dist --recursive
    if: branch = master
    install:
    - VERSIONS="3.6.0" ./bin/install-python-macos.sh
    script:
    - VERIONS="3.6.0" ./bin/test-wheels-macos.sh
  - stage: testpypi
    language: generic
    if: branch = master and repo = danielsuo/brainiak
  - os: linux
    dist: trusty
    sudo: required
    language: python
    python: '3.4'
    before_install:
    - python3 -m pip install -U pip awscli twine
    env:
    - TWINE_REPOSITORY_URL=https://pypi.python.org/pypi
    - PYPI_REPOSITORY_URL=https://testpypi.python.org
    script: ./bin/test-wheels.sh
    after_script:
    - ;
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - TWINE_REPOSITORY_URL=https://pypi.python.org/pypi
    - PYPI_REPOSITORY_URL=https://testpypi.python.org
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    install:
    - VERSIONS="3.4.4" ./bin/install-python-macos.sh
    script:
    - VERIONS="3.4.4" ./bin/test-wheels-macos.sh
    after_script:
    - ;
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - TWINE_REPOSITORY_URL=https://pypi.python.org/pypi
    - PYPI_REPOSITORY_URL=https://testpypi.python.org
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    install:
    - VERSIONS="3.5.3" ./bin/install-python-macos.sh
    script:
    - VERIONS="3.5.3" ./bin/test-wheels-macos.sh
    after_script:
    - ;
  - os: osx
    osx_image: xcode7.3
    language: generic
    env:
    - TWINE_REPOSITORY_URL=https://pypi.python.org/pypi
    - PYPI_REPOSITORY_URL=https://testpypi.python.org
    before_install:
    - brew update
    - brew install python3
    - python3 -m pip install -U pip awscli twine
    if: branch = master
    install:
    - VERSIONS="3.6.0" ./bin/install-python-macos.sh
    script:
    - VERIONS="3.6.0" ./bin/test-wheels-macos.sh
    after_script:
    - ;
  - stage: pypi
    language: generic
    if: branch = master and repo = danielsuo/brainiak and tag IS present
